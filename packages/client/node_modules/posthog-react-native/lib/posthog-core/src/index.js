"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _typeof3=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:true});var _exportNames={PostHogCoreStateless:true,PostHogCore:true,utils:true,LZString:true};Object.defineProperty(exports,"LZString",{enumerable:true,get:function get(){return _lzString.LZString;}});exports.utils=exports.PostHogCoreStateless=exports.PostHogCore=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _get2=_interopRequireDefault(require("@babel/runtime/helpers/get"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _wrapNativeSuper2=_interopRequireDefault(require("@babel/runtime/helpers/wrapNativeSuper"));var _types=require("./types");Object.keys(_types).forEach(function(key){if(key==="default"||key==="__esModule")return;if(Object.prototype.hasOwnProperty.call(_exportNames,key))return;if(key in exports&&exports[key]===_types[key])return;Object.defineProperty(exports,key,{enumerable:true,get:function get(){return _types[key];}});});var _utils2=_interopRequireWildcard(require("./utils"));var _utils=_utils2;exports.utils=_utils2;var _lzString=require("./lz-string");var _eventemitter=require("./eventemitter");var _uuidv=require("./vendor/uuidv7");function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap(),t=new WeakMap();return(_getRequireWildcardCache=function _getRequireWildcardCache(e){return e?t:r;})(e);}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=_typeof3(e)&&"function"!=typeof e)return{"default":e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in e)if("default"!==u&&{}.hasOwnProperty.call(e,u)){var i=a?Object.getOwnPropertyDescriptor(e,u):null;i&&(i.get||i.set)?Object.defineProperty(n,u,i):n[u]=e[u];}return n["default"]=e,t&&t.set(e,n),n;}function _superPropGet(t,e,o,r){var p=(0,_get2["default"])((0,_getPrototypeOf2["default"])(1&r?t.prototype:t),e,o);return 2&r&&"function"==typeof p?function(t){return p.apply(o,t);}:p;}function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable;})),t.push.apply(t,o);}return t;}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach(function(r){(0,_defineProperty2["default"])(e,r,t[r]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r));});}return e;}function _callSuper(t,o,e){return o=(0,_getPrototypeOf2["default"])(o),(0,_possibleConstructorReturn2["default"])(t,_isNativeReflectConstruct()?Reflect.construct(o,e||[],(0,_getPrototypeOf2["default"])(t).constructor):o.apply(t,e));}function _isNativeReflectConstruct(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));}catch(t){}return(_isNativeReflectConstruct=function _isNativeReflectConstruct(){return!!t;})();}var PostHogFetchHttpError=function(_Error){function PostHogFetchHttpError(response){var _this;(0,_classCallCheck2["default"])(this,PostHogFetchHttpError);_this=_callSuper(this,PostHogFetchHttpError,['HTTP error while fetching PostHog: '+response.status]);_this.response=response;_this.name='PostHogFetchHttpError';return _this;}(0,_inherits2["default"])(PostHogFetchHttpError,_Error);return(0,_createClass2["default"])(PostHogFetchHttpError);}((0,_wrapNativeSuper2["default"])(Error));var PostHogFetchNetworkError=function(_Error2){function PostHogFetchNetworkError(error){var _this2;(0,_classCallCheck2["default"])(this,PostHogFetchNetworkError);_this2=_callSuper(this,PostHogFetchNetworkError,['Network error while fetching PostHog',error instanceof Error?{cause:error}:{}]);_this2.error=error;_this2.name='PostHogFetchNetworkError';return _this2;}(0,_inherits2["default"])(PostHogFetchNetworkError,_Error2);return(0,_createClass2["default"])(PostHogFetchNetworkError);}((0,_wrapNativeSuper2["default"])(Error));function isPostHogFetchError(err){return(0,_typeof2["default"])(err)==='object'&&(err instanceof PostHogFetchHttpError||err instanceof PostHogFetchNetworkError);}var PostHogCoreStateless=exports.PostHogCoreStateless=function(){function PostHogCoreStateless(apiKey,options){(0,_classCallCheck2["default"])(this,PostHogCoreStateless);var _a,_b,_c,_d,_e,_f,_g,_h,_j,_k,_l;this.flushPromise=null;this.disableGeoip=true;this.historicalMigration=false;this.disabled=false;this.defaultOptIn=true;this.pendingPromises={};this._events=new _eventemitter.SimpleEventEmitter();this._isInitialized=false;(0,_utils2.assert)(apiKey,"You must pass your PostHog project's api key.");this.apiKey=apiKey;this.host=(0,_utils2.removeTrailingSlash)((options===null||options===void 0?void 0:options.host)||'https://us.i.posthog.com');this.flushAt=(options===null||options===void 0?void 0:options.flushAt)?Math.max(options===null||options===void 0?void 0:options.flushAt,1):20;this.maxBatchSize=Math.max(this.flushAt,(_a=options===null||options===void 0?void 0:options.maxBatchSize)!==null&&_a!==void 0?_a:100);this.maxQueueSize=Math.max(this.flushAt,(_b=options===null||options===void 0?void 0:options.maxQueueSize)!==null&&_b!==void 0?_b:1000);this.flushInterval=(_c=options===null||options===void 0?void 0:options.flushInterval)!==null&&_c!==void 0?_c:10000;this.captureMode=(options===null||options===void 0?void 0:options.captureMode)||'json';this.defaultOptIn=(_d=options===null||options===void 0?void 0:options.defaultOptIn)!==null&&_d!==void 0?_d:true;this._retryOptions={retryCount:(_e=options===null||options===void 0?void 0:options.fetchRetryCount)!==null&&_e!==void 0?_e:3,retryDelay:(_f=options===null||options===void 0?void 0:options.fetchRetryDelay)!==null&&_f!==void 0?_f:3000,retryCheck:isPostHogFetchError};this.requestTimeout=(_g=options===null||options===void 0?void 0:options.requestTimeout)!==null&&_g!==void 0?_g:10000;this.featureFlagsRequestTimeoutMs=(_h=options===null||options===void 0?void 0:options.featureFlagsRequestTimeoutMs)!==null&&_h!==void 0?_h:3000;this.disableGeoip=(_j=options===null||options===void 0?void 0:options.disableGeoip)!==null&&_j!==void 0?_j:true;this.disabled=(_k=options===null||options===void 0?void 0:options.disabled)!==null&&_k!==void 0?_k:false;this.historicalMigration=(_l=options===null||options===void 0?void 0:options.historicalMigration)!==null&&_l!==void 0?_l:false;this._initPromise=Promise.resolve();this._isInitialized=true;}return(0,_createClass2["default"])(PostHogCoreStateless,[{key:"logMsgIfDebug",value:function logMsgIfDebug(fn){if(this.isDebug){fn();}}},{key:"wrap",value:function wrap(fn){if(this.disabled){this.logMsgIfDebug(function(){return console.warn('[PostHog] The client is disabled');});return;}if(this._isInitialized){return fn();}this._initPromise.then(function(){return fn();});}},{key:"getCommonEventProperties",value:function getCommonEventProperties(){return{$lib:this.getLibraryId(),$lib_version:this.getLibraryVersion()};}},{key:"optedOut",get:function get(){var _a;return(_a=this.getPersistedProperty(_types.PostHogPersistedProperty.OptedOut))!==null&&_a!==void 0?_a:!this.defaultOptIn;}},{key:"optIn",value:function(){var _optIn=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee(){var _this3=this;return _regenerator["default"].wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:this.wrap(function(){_this3.setPersistedProperty(_types.PostHogPersistedProperty.OptedOut,false);});case 1:case"end":return _context.stop();}},_callee,this);}));function optIn(){return _optIn.apply(this,arguments);}return optIn;}()},{key:"optOut",value:function(){var _optOut=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee2(){var _this4=this;return _regenerator["default"].wrap(function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:this.wrap(function(){_this4.setPersistedProperty(_types.PostHogPersistedProperty.OptedOut,true);});case 1:case"end":return _context2.stop();}},_callee2,this);}));function optOut(){return _optOut.apply(this,arguments);}return optOut;}()},{key:"on",value:function on(event,cb){return this._events.on(event,cb);}},{key:"debug",value:function debug(){var _this5=this;var enabled=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;var _a;(_a=this.removeDebugCallback)===null||_a===void 0?void 0:_a.call(this);if(enabled){var removeDebugCallback=this.on('*',function(event,payload){return console.log('PostHog Debug',event,payload);});this.removeDebugCallback=function(){removeDebugCallback();_this5.removeDebugCallback=undefined;};}}},{key:"isDebug",get:function get(){return!!this.removeDebugCallback;}},{key:"isDisabled",get:function get(){return this.disabled;}},{key:"buildPayload",value:function buildPayload(payload){return{distinct_id:payload.distinct_id,event:payload.event,properties:_objectSpread(_objectSpread({},payload.properties||{}),this.getCommonEventProperties())};}},{key:"addPendingPromise",value:function addPendingPromise(promise){var _this6=this;var promiseUUID=(0,_uuidv.uuidv7)();this.pendingPromises[promiseUUID]=promise;promise["catch"](function(){})["finally"](function(){delete _this6.pendingPromises[promiseUUID];});return promise;}},{key:"identifyStateless",value:function identifyStateless(distinctId,properties,options){var _this7=this;this.wrap(function(){var payload=_objectSpread({},_this7.buildPayload({distinct_id:distinctId,event:'$identify',properties:properties}));_this7.enqueue('identify',payload,options);});}},{key:"captureStateless",value:function captureStateless(distinctId,event,properties,options){var _this8=this;this.wrap(function(){var payload=_this8.buildPayload({distinct_id:distinctId,event:event,properties:properties});_this8.enqueue('capture',payload,options);});}},{key:"aliasStateless",value:function aliasStateless(alias,distinctId,properties,options){var _this9=this;this.wrap(function(){var payload=_this9.buildPayload({event:'$create_alias',distinct_id:distinctId,properties:_objectSpread(_objectSpread({},properties||{}),{},{distinct_id:distinctId,alias:alias})});_this9.enqueue('alias',payload,options);});}},{key:"groupIdentifyStateless",value:function groupIdentifyStateless(groupType,groupKey,groupProperties,options,distinctId,eventProperties){var _this10=this;this.wrap(function(){var payload=_this10.buildPayload({distinct_id:distinctId||"$".concat(groupType,"_").concat(groupKey),event:'$groupidentify',properties:_objectSpread({$group_type:groupType,$group_key:groupKey,$group_set:groupProperties||{}},eventProperties||{})});_this10.enqueue('capture',payload,options);});}},{key:"getDecide",value:(function(){var _getDecide=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee3(distinctId){var _this11=this;var groups,personProperties,groupProperties,extraPayload,url,fetchOptions,_args3=arguments;return _regenerator["default"].wrap(function _callee3$(_context3){while(1)switch(_context3.prev=_context3.next){case 0:groups=_args3.length>1&&_args3[1]!==undefined?_args3[1]:{};personProperties=_args3.length>2&&_args3[2]!==undefined?_args3[2]:{};groupProperties=_args3.length>3&&_args3[3]!==undefined?_args3[3]:{};extraPayload=_args3.length>4&&_args3[4]!==undefined?_args3[4]:{};_context3.next=6;return this._initPromise;case 6:url="".concat(this.host,"/decide/?v=3");fetchOptions={method:'POST',headers:_objectSpread(_objectSpread({},this.getCustomHeaders()),{},{'Content-Type':'application/json'}),body:JSON.stringify(_objectSpread({token:this.apiKey,distinct_id:distinctId,groups:groups,person_properties:personProperties,group_properties:groupProperties},extraPayload))};return _context3.abrupt("return",this.fetchWithRetry(url,fetchOptions,{retryCount:0},this.featureFlagsRequestTimeoutMs).then(function(response){return response.json();})["catch"](function(error){_this11._events.emit('error',error);return undefined;}));case 9:case"end":return _context3.stop();}},_callee3,this);}));function getDecide(_x){return _getDecide.apply(this,arguments);}return getDecide;}())},{key:"getFeatureFlagStateless",value:function(){var _getFeatureFlagStateless=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee4(key,distinctId){var groups,personProperties,groupProperties,disableGeoip,featureFlags,response,_args4=arguments;return _regenerator["default"].wrap(function _callee4$(_context4){while(1)switch(_context4.prev=_context4.next){case 0:groups=_args4.length>2&&_args4[2]!==undefined?_args4[2]:{};personProperties=_args4.length>3&&_args4[3]!==undefined?_args4[3]:{};groupProperties=_args4.length>4&&_args4[4]!==undefined?_args4[4]:{};disableGeoip=_args4.length>5?_args4[5]:undefined;_context4.next=6;return this._initPromise;case 6:_context4.next=8;return this.getFeatureFlagsStateless(distinctId,groups,personProperties,groupProperties,disableGeoip);case 8:featureFlags=_context4.sent;if(featureFlags){_context4.next=11;break;}return _context4.abrupt("return",undefined);case 11:response=featureFlags[key];if(response===undefined){response=false;}return _context4.abrupt("return",response);case 14:case"end":return _context4.stop();}},_callee4,this);}));function getFeatureFlagStateless(_x2,_x3){return _getFeatureFlagStateless.apply(this,arguments);}return getFeatureFlagStateless;}()},{key:"getFeatureFlagPayloadStateless",value:function(){var _getFeatureFlagPayloadStateless=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee5(key,distinctId){var groups,personProperties,groupProperties,disableGeoip,payloads,response,_args5=arguments;return _regenerator["default"].wrap(function _callee5$(_context5){while(1)switch(_context5.prev=_context5.next){case 0:groups=_args5.length>2&&_args5[2]!==undefined?_args5[2]:{};personProperties=_args5.length>3&&_args5[3]!==undefined?_args5[3]:{};groupProperties=_args5.length>4&&_args5[4]!==undefined?_args5[4]:{};disableGeoip=_args5.length>5?_args5[5]:undefined;_context5.next=6;return this._initPromise;case 6:_context5.next=8;return this.getFeatureFlagPayloadsStateless(distinctId,groups,personProperties,groupProperties,disableGeoip);case 8:payloads=_context5.sent;if(payloads){_context5.next=11;break;}return _context5.abrupt("return",undefined);case 11:response=payloads[key];if(!(response===undefined)){_context5.next=14;break;}return _context5.abrupt("return",null);case 14:return _context5.abrupt("return",response);case 15:case"end":return _context5.stop();}},_callee5,this);}));function getFeatureFlagPayloadStateless(_x4,_x5){return _getFeatureFlagPayloadStateless.apply(this,arguments);}return getFeatureFlagPayloadStateless;}()},{key:"getFeatureFlagPayloadsStateless",value:function(){var _getFeatureFlagPayloadsStateless=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee6(distinctId){var groups,personProperties,groupProperties,disableGeoip,payloads,_args6=arguments;return _regenerator["default"].wrap(function _callee6$(_context6){while(1)switch(_context6.prev=_context6.next){case 0:groups=_args6.length>1&&_args6[1]!==undefined?_args6[1]:{};personProperties=_args6.length>2&&_args6[2]!==undefined?_args6[2]:{};groupProperties=_args6.length>3&&_args6[3]!==undefined?_args6[3]:{};disableGeoip=_args6.length>4?_args6[4]:undefined;_context6.next=6;return this._initPromise;case 6:_context6.next=8;return this.getFeatureFlagsAndPayloadsStateless(distinctId,groups,personProperties,groupProperties,disableGeoip);case 8:payloads=_context6.sent.payloads;return _context6.abrupt("return",payloads);case 10:case"end":return _context6.stop();}},_callee6,this);}));function getFeatureFlagPayloadsStateless(_x6){return _getFeatureFlagPayloadsStateless.apply(this,arguments);}return getFeatureFlagPayloadsStateless;}()},{key:"_parsePayload",value:function _parsePayload(response){try{return JSON.parse(response);}catch(_a){return response;}}},{key:"getFeatureFlagsStateless",value:function(){var _getFeatureFlagsStateless=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee7(distinctId){var groups,personProperties,groupProperties,disableGeoip,_args7=arguments;return _regenerator["default"].wrap(function _callee7$(_context7){while(1)switch(_context7.prev=_context7.next){case 0:groups=_args7.length>1&&_args7[1]!==undefined?_args7[1]:{};personProperties=_args7.length>2&&_args7[2]!==undefined?_args7[2]:{};groupProperties=_args7.length>3&&_args7[3]!==undefined?_args7[3]:{};disableGeoip=_args7.length>4?_args7[4]:undefined;_context7.next=6;return this._initPromise;case 6:_context7.next=8;return this.getFeatureFlagsAndPayloadsStateless(distinctId,groups,personProperties,groupProperties,disableGeoip);case 8:return _context7.abrupt("return",_context7.sent.flags);case 9:case"end":return _context7.stop();}},_callee7,this);}));function getFeatureFlagsStateless(_x7){return _getFeatureFlagsStateless.apply(this,arguments);}return getFeatureFlagsStateless;}()},{key:"getFeatureFlagsAndPayloadsStateless",value:function(){var _getFeatureFlagsAndPayloadsStateless=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee8(distinctId){var _this12=this;var groups,personProperties,groupProperties,disableGeoip,extraPayload,decideResponse,flags,payloads,parsedPayloads,_args8=arguments;return _regenerator["default"].wrap(function _callee8$(_context8){while(1)switch(_context8.prev=_context8.next){case 0:groups=_args8.length>1&&_args8[1]!==undefined?_args8[1]:{};personProperties=_args8.length>2&&_args8[2]!==undefined?_args8[2]:{};groupProperties=_args8.length>3&&_args8[3]!==undefined?_args8[3]:{};disableGeoip=_args8.length>4?_args8[4]:undefined;_context8.next=6;return this._initPromise;case 6:extraPayload={};if(disableGeoip!==null&&disableGeoip!==void 0?disableGeoip:this.disableGeoip){extraPayload['geoip_disable']=true;}_context8.next=10;return this.getDecide(distinctId,groups,personProperties,groupProperties,extraPayload);case 10:decideResponse=_context8.sent;flags=decideResponse===null||decideResponse===void 0?void 0:decideResponse.featureFlags;payloads=decideResponse===null||decideResponse===void 0?void 0:decideResponse.featureFlagPayloads;parsedPayloads=payloads;if(payloads){parsedPayloads=Object.fromEntries(Object.entries(payloads).map(function(_ref){var _ref2=(0,_slicedToArray2["default"])(_ref,2),k=_ref2[0],v=_ref2[1];return[k,_this12._parsePayload(v)];}));}return _context8.abrupt("return",{flags:flags,payloads:parsedPayloads});case 16:case"end":return _context8.stop();}},_callee8,this);}));function getFeatureFlagsAndPayloadsStateless(_x8){return _getFeatureFlagsAndPayloadsStateless.apply(this,arguments);}return getFeatureFlagsAndPayloadsStateless;}()},{key:"enqueue",value:function enqueue(type,_message,options){var _this13=this;this.wrap(function(){var _a;if(_this13.optedOut){_this13._events.emit(type,"Library is disabled. Not sending event. To re-enable, call posthog.optIn()");return;}var message=_objectSpread(_objectSpread({},_message),{},{type:type,library:_this13.getLibraryId(),library_version:_this13.getLibraryVersion(),timestamp:(options===null||options===void 0?void 0:options.timestamp)?options===null||options===void 0?void 0:options.timestamp:(0,_utils2.currentISOTime)(),uuid:(options===null||options===void 0?void 0:options.uuid)?options.uuid:(0,_uuidv.uuidv7)()});var addGeoipDisableProperty=(_a=options===null||options===void 0?void 0:options.disableGeoip)!==null&&_a!==void 0?_a:_this13.disableGeoip;if(addGeoipDisableProperty){if(!message.properties){message.properties={};}message['properties']['$geoip_disable']=true;}if(message.distinctId){message.distinct_id=message.distinctId;delete message.distinctId;}var queue=_this13.getPersistedProperty(_types.PostHogPersistedProperty.Queue)||[];if(queue.length>=_this13.maxQueueSize){queue.shift();_this13.logMsgIfDebug(function(){return console.info('Queue is full, the oldest event is dropped.');});}queue.push({message:message});_this13.setPersistedProperty(_types.PostHogPersistedProperty.Queue,queue);_this13._events.emit(type,message);if(queue.length>=_this13.flushAt){_this13.flushBackground();}if(_this13.flushInterval&&!_this13._flushTimer){_this13._flushTimer=(0,_utils2.safeSetTimeout)(function(){return _this13.flushBackground();},_this13.flushInterval);}});}},{key:"clearFlushTimer",value:function clearFlushTimer(){if(this._flushTimer){clearTimeout(this._flushTimer);this._flushTimer=undefined;}}},{key:"flushBackground",value:function flushBackground(){void this.flush()["catch"](function(){});}},{key:"flush",value:function(){var _flush2=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee9(){var _this14=this;return _regenerator["default"].wrap(function _callee9$(_context9){while(1)switch(_context9.prev=_context9.next){case 0:if(!this.flushPromise){this.flushPromise=this._flush()["finally"](function(){_this14.flushPromise=null;});this.addPendingPromise(this.flushPromise);}return _context9.abrupt("return",this.flushPromise);case 2:case"end":return _context9.stop();}},_callee9,this);}));function flush(){return _flush2.apply(this,arguments);}return flush;}()},{key:"getCustomHeaders",value:function getCustomHeaders(){var customUserAgent=this.getCustomUserAgent();var headers={};if(customUserAgent&&customUserAgent!==''){headers['User-Agent']=customUserAgent;}return headers;}},{key:"_flush",value:function(){var _flush3=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee10(){var _this15=this;var queue,items,messages,persistQueueChange,data,payload,url,fetchOptions;return _regenerator["default"].wrap(function _callee10$(_context10){while(1)switch(_context10.prev=_context10.next){case 0:this.clearFlushTimer();_context10.next=3;return this._initPromise;case 3:queue=this.getPersistedProperty(_types.PostHogPersistedProperty.Queue)||[];if(queue.length){_context10.next=6;break;}return _context10.abrupt("return",[]);case 6:items=queue.slice(0,this.maxBatchSize);messages=items.map(function(item){return item.message;});persistQueueChange=function persistQueueChange(){var refreshedQueue=_this15.getPersistedProperty(_types.PostHogPersistedProperty.Queue)||[];_this15.setPersistedProperty(_types.PostHogPersistedProperty.Queue,refreshedQueue.slice(items.length));};data={api_key:this.apiKey,batch:messages,sent_at:(0,_utils2.currentISOTime)()};if(this.historicalMigration){data.historical_migration=true;}payload=JSON.stringify(data);url=this.captureMode==='form'?"".concat(this.host,"/e/?ip=1&_=").concat((0,_utils2.currentTimestamp)(),"&v=").concat(this.getLibraryVersion()):"".concat(this.host,"/batch/");fetchOptions=this.captureMode==='form'?{method:'POST',mode:'no-cors',credentials:'omit',headers:_objectSpread(_objectSpread({},this.getCustomHeaders()),{},{'Content-Type':'application/x-www-form-urlencoded'}),body:"data=".concat(encodeURIComponent(_lzString.LZString.compressToBase64(payload)),"&compression=lz64")}:{method:'POST',headers:_objectSpread(_objectSpread({},this.getCustomHeaders()),{},{'Content-Type':'application/json'}),body:payload};_context10.prev=14;_context10.next=17;return this.fetchWithRetry(url,fetchOptions);case 17:_context10.next=24;break;case 19:_context10.prev=19;_context10.t0=_context10["catch"](14);if(!(_context10.t0 instanceof PostHogFetchNetworkError)){persistQueueChange();}this._events.emit('error',_context10.t0);throw _context10.t0;case 24:persistQueueChange();this._events.emit('flush',messages);return _context10.abrupt("return",messages);case 27:case"end":return _context10.stop();}},_callee10,this,[[14,19]]);}));function _flush(){return _flush3.apply(this,arguments);}return _flush;}()},{key:"fetchWithRetry",value:function(){var _fetchWithRetry=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee12(url,options,retryOptions,requestTimeout){var _this16=this;var _a,_b;return _regenerator["default"].wrap(function _callee12$(_context12){while(1)switch(_context12.prev=_context12.next){case 0:;(_a=(_b=AbortSignal).timeout)!==null&&_a!==void 0?_a:_b.timeout=function timeout(ms){var ctrl=new AbortController();setTimeout(function(){return ctrl.abort();},ms);return ctrl.signal;};_context12.next=4;return(0,_utils2.retriable)((0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee11(){var res,isNoCors;return _regenerator["default"].wrap(function _callee11$(_context11){while(1)switch(_context11.prev=_context11.next){case 0:res=null;_context11.prev=1;_context11.next=4;return _this16.fetch(url,_objectSpread({signal:AbortSignal.timeout(requestTimeout!==null&&requestTimeout!==void 0?requestTimeout:_this16.requestTimeout)},options));case 4:res=_context11.sent;_context11.next=10;break;case 7:_context11.prev=7;_context11.t0=_context11["catch"](1);throw new PostHogFetchNetworkError(_context11.t0);case 10:isNoCors=options.mode==='no-cors';if(!(!isNoCors&&(res.status<200||res.status>=400))){_context11.next=13;break;}throw new PostHogFetchHttpError(res);case 13:return _context11.abrupt("return",res);case 14:case"end":return _context11.stop();}},_callee11,null,[[1,7]]);})),_objectSpread(_objectSpread({},this._retryOptions),retryOptions));case 4:return _context12.abrupt("return",_context12.sent);case 5:case"end":return _context12.stop();}},_callee12,this);}));function fetchWithRetry(_x9,_x10,_x11,_x12){return _fetchWithRetry.apply(this,arguments);}return fetchWithRetry;}()},{key:"shutdown",value:function(){var _shutdown=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee14(){var _this17=this;var shutdownTimeoutMs,hasTimedOut,doShutdown,_args14=arguments;return _regenerator["default"].wrap(function _callee14$(_context14){while(1)switch(_context14.prev=_context14.next){case 0:shutdownTimeoutMs=_args14.length>0&&_args14[0]!==undefined?_args14[0]:30000;_context14.next=3;return this._initPromise;case 3:hasTimedOut=false;this.clearFlushTimer();doShutdown=function(){var _ref4=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee13(){var queue;return _regenerator["default"].wrap(function _callee13$(_context13){while(1)switch(_context13.prev=_context13.next){case 0:_context13.prev=0;_context13.next=3;return Promise.all(Object.values(_this17.pendingPromises));case 3:if(!true){_context13.next=13;break;}queue=_this17.getPersistedProperty(_types.PostHogPersistedProperty.Queue)||[];if(!(queue.length===0)){_context13.next=7;break;}return _context13.abrupt("break",13);case 7:_context13.next=9;return _this17.flush();case 9:if(!hasTimedOut){_context13.next=11;break;}return _context13.abrupt("break",13);case 11:_context13.next=3;break;case 13:_context13.next=20;break;case 15:_context13.prev=15;_context13.t0=_context13["catch"](0);if(isPostHogFetchError(_context13.t0)){_context13.next=19;break;}throw _context13.t0;case 19:_this17.logMsgIfDebug(function(){return console.error('Error while shutting down PostHog',_context13.t0);});case 20:case"end":return _context13.stop();}},_callee13,null,[[0,15]]);}));return function doShutdown(){return _ref4.apply(this,arguments);};}();return _context14.abrupt("return",Promise.race([new Promise(function(_,reject){(0,_utils2.safeSetTimeout)(function(){_this17.logMsgIfDebug(function(){return console.error('Timed out while shutting down PostHog');});hasTimedOut=true;reject('Timeout while shutting down PostHog. Some events may not have been sent.');},shutdownTimeoutMs);}),doShutdown()]));case 7:case"end":return _context14.stop();}},_callee14,this);}));function shutdown(){return _shutdown.apply(this,arguments);}return shutdown;}()}]);}();var PostHogCore=exports.PostHogCore=function(_PostHogCoreStateless){function PostHogCore(apiKey,options){var _this18;(0,_classCallCheck2["default"])(this,PostHogCore);var _a,_b,_c,_d;var disableGeoipOption=(_a=options===null||options===void 0?void 0:options.disableGeoip)!==null&&_a!==void 0?_a:false;var featureFlagsRequestTimeoutMs=(_b=options===null||options===void 0?void 0:options.featureFlagsRequestTimeoutMs)!==null&&_b!==void 0?_b:10000;_this18=_callSuper(this,PostHogCore,[apiKey,_objectSpread(_objectSpread({},options),{},{disableGeoip:disableGeoipOption,featureFlagsRequestTimeoutMs:featureFlagsRequestTimeoutMs})]);_this18.flagCallReported={};_this18.sessionProps={};_this18.sendFeatureFlagEvent=(_c=options===null||options===void 0?void 0:options.sendFeatureFlagEvent)!==null&&_c!==void 0?_c:true;_this18._sessionExpirationTimeSeconds=(_d=options===null||options===void 0?void 0:options.sessionExpirationTimeSeconds)!==null&&_d!==void 0?_d:1800;return _this18;}(0,_inherits2["default"])(PostHogCore,_PostHogCoreStateless);return(0,_createClass2["default"])(PostHogCore,[{key:"setupBootstrap",value:function setupBootstrap(options){var bootstrap=options===null||options===void 0?void 0:options.bootstrap;if(!bootstrap){return;}if(bootstrap.distinctId){if(bootstrap.isIdentifiedId){var distinctId=this.getPersistedProperty(_types.PostHogPersistedProperty.DistinctId);if(!distinctId){this.setPersistedProperty(_types.PostHogPersistedProperty.DistinctId,bootstrap.distinctId);}}else{var anonymousId=this.getPersistedProperty(_types.PostHogPersistedProperty.AnonymousId);if(!anonymousId){this.setPersistedProperty(_types.PostHogPersistedProperty.AnonymousId,bootstrap.distinctId);}}}var bootstrapfeatureFlags=bootstrap.featureFlags;if(bootstrapfeatureFlags&&Object.keys(bootstrapfeatureFlags).length){var bootstrapFlags=Object.keys(bootstrapfeatureFlags).filter(function(flag){return!!bootstrapfeatureFlags[flag];}).reduce(function(res,key){return res[key]=bootstrapfeatureFlags[key]||false,res;},{});if(Object.keys(bootstrapFlags).length){var currentFlags=this.getPersistedProperty(_types.PostHogPersistedProperty.FeatureFlags)||{};var newFeatureFlags=_objectSpread(_objectSpread({},bootstrapFlags),currentFlags);this.setKnownFeatureFlags(newFeatureFlags);}var bootstrapFlagPayloads=bootstrap.featureFlagPayloads;if(bootstrapFlagPayloads&&Object.keys(bootstrapFlagPayloads).length){var currentFlagPayloads=this.getPersistedProperty(_types.PostHogPersistedProperty.FeatureFlagPayloads)||{};var newFeatureFlagPayloads=_objectSpread(_objectSpread({},bootstrapFlagPayloads),currentFlagPayloads);this.setKnownFeatureFlagPayloads(newFeatureFlagPayloads);}}}},{key:"props",get:function get(){if(!this._props){this._props=this.getPersistedProperty(_types.PostHogPersistedProperty.Props);}return this._props||{};},set:function set(val){this._props=val;}},{key:"clearProps",value:function clearProps(){this.props=undefined;this.sessionProps={};this.flagCallReported={};}},{key:"on",value:function on(event,cb){return this._events.on(event,cb);}},{key:"reset",value:function reset(propertiesToKeep){var _this19=this;this.wrap(function(){var allPropertiesToKeep=[_types.PostHogPersistedProperty.Queue].concat((0,_toConsumableArray2["default"])(propertiesToKeep||[]));_this19.clearProps();for(var _i=0,_Object$keys=Object.keys(_types.PostHogPersistedProperty);_i<_Object$keys.length;_i++){var key=_Object$keys[_i];if(!allPropertiesToKeep.includes(_types.PostHogPersistedProperty[key])){_this19.setPersistedProperty(_types.PostHogPersistedProperty[key],null);}}});}},{key:"getCommonEventProperties",value:function getCommonEventProperties(){var featureFlags=this.getFeatureFlags();var featureVariantProperties={};if(featureFlags){for(var _i2=0,_Object$entries=Object.entries(featureFlags);_i2<_Object$entries.length;_i2++){var _Object$entries$_i=(0,_slicedToArray2["default"])(_Object$entries[_i2],2),feature=_Object$entries$_i[0],variant=_Object$entries$_i[1];featureVariantProperties["$feature/".concat(feature)]=variant;}}return _objectSpread(_objectSpread({$active_feature_flags:featureFlags?Object.keys(featureFlags):undefined},featureVariantProperties),_superPropGet(PostHogCore,"getCommonEventProperties",this,3)([]));}},{key:"enrichProperties",value:function enrichProperties(properties){return _objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread({},this.props),this.sessionProps),properties||{}),this.getCommonEventProperties()),{},{$session_id:this.getSessionId()});}},{key:"getSessionId",value:function getSessionId(){if(!this._isInitialized){return'';}var sessionId=this.getPersistedProperty(_types.PostHogPersistedProperty.SessionId);var sessionTimestamp=this.getPersistedProperty(_types.PostHogPersistedProperty.SessionLastTimestamp)||0;if(!sessionId||Date.now()-sessionTimestamp>this._sessionExpirationTimeSeconds*1000){sessionId=(0,_uuidv.uuidv7)();this.setPersistedProperty(_types.PostHogPersistedProperty.SessionId,sessionId);}this.setPersistedProperty(_types.PostHogPersistedProperty.SessionLastTimestamp,Date.now());return sessionId;}},{key:"resetSessionId",value:function resetSessionId(){var _this20=this;this.wrap(function(){_this20.setPersistedProperty(_types.PostHogPersistedProperty.SessionId,null);_this20.setPersistedProperty(_types.PostHogPersistedProperty.SessionLastTimestamp,null);});}},{key:"getAnonymousId",value:function getAnonymousId(){if(!this._isInitialized){return'';}var anonId=this.getPersistedProperty(_types.PostHogPersistedProperty.AnonymousId);if(!anonId){anonId=(0,_uuidv.uuidv7)();this.setPersistedProperty(_types.PostHogPersistedProperty.AnonymousId,anonId);}return anonId;}},{key:"getDistinctId",value:function getDistinctId(){if(!this._isInitialized){return'';}return this.getPersistedProperty(_types.PostHogPersistedProperty.DistinctId)||this.getAnonymousId();}},{key:"unregister",value:function(){var _unregister=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee15(property){var _this21=this;return _regenerator["default"].wrap(function _callee15$(_context15){while(1)switch(_context15.prev=_context15.next){case 0:this.wrap(function(){delete _this21.props[property];_this21.setPersistedProperty(_types.PostHogPersistedProperty.Props,_this21.props);});case 1:case"end":return _context15.stop();}},_callee15,this);}));function unregister(_x13){return _unregister.apply(this,arguments);}return unregister;}()},{key:"register",value:function(){var _register=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee16(properties){var _this22=this;return _regenerator["default"].wrap(function _callee16$(_context16){while(1)switch(_context16.prev=_context16.next){case 0:this.wrap(function(){_this22.props=_objectSpread(_objectSpread({},_this22.props),properties);_this22.setPersistedProperty(_types.PostHogPersistedProperty.Props,_this22.props);});case 1:case"end":return _context16.stop();}},_callee16,this);}));function register(_x14){return _register.apply(this,arguments);}return register;}()},{key:"registerForSession",value:function registerForSession(properties){this.sessionProps=_objectSpread(_objectSpread({},this.sessionProps),properties);}},{key:"unregisterForSession",value:function unregisterForSession(property){delete this.sessionProps[property];}},{key:"identify",value:function identify(distinctId,properties,options){var _this23=this;this.wrap(function(){var previousDistinctId=_this23.getDistinctId();distinctId=distinctId||previousDistinctId;if(properties===null||properties===void 0?void 0:properties.$groups){_this23.groups(properties.$groups);}var userPropsOnce=properties===null||properties===void 0?void 0:properties.$set_once;properties===null||properties===void 0?true:delete properties.$set_once;var userProps=(properties===null||properties===void 0?void 0:properties.$set)||properties;var allProperties=_this23.enrichProperties({$anon_distinct_id:_this23.getAnonymousId(),$set:userProps,$set_once:userPropsOnce});if(distinctId!==previousDistinctId){_this23.setPersistedProperty(_types.PostHogPersistedProperty.AnonymousId,previousDistinctId);_this23.setPersistedProperty(_types.PostHogPersistedProperty.DistinctId,distinctId);_this23.reloadFeatureFlags();}_superPropGet(PostHogCore,"identifyStateless",_this23,3)([distinctId,allProperties,options]);});}},{key:"capture",value:function capture(event,properties,options){var _this24=this;this.wrap(function(){var distinctId=_this24.getDistinctId();if(properties===null||properties===void 0?void 0:properties.$groups){_this24.groups(properties.$groups);}var allProperties=_this24.enrichProperties(properties);_superPropGet(PostHogCore,"captureStateless",_this24,3)([distinctId,event,allProperties,options]);});}},{key:"alias",value:function alias(_alias){var _this25=this;this.wrap(function(){var distinctId=_this25.getDistinctId();var allProperties=_this25.enrichProperties({});_superPropGet(PostHogCore,"aliasStateless",_this25,3)([_alias,distinctId,allProperties]);});}},{key:"autocapture",value:function autocapture(eventType,elements){var _this26=this;var properties=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var options=arguments.length>3?arguments[3]:undefined;this.wrap(function(){var distinctId=_this26.getDistinctId();var payload={distinct_id:distinctId,event:'$autocapture',properties:_objectSpread(_objectSpread({},_this26.enrichProperties(properties)),{},{$event_type:eventType,$elements:elements})};_this26.enqueue('autocapture',payload,options);});}},{key:"groups",value:function groups(_groups){var _this27=this;this.wrap(function(){var existingGroups=_this27.props.$groups||{};_this27.register({$groups:_objectSpread(_objectSpread({},existingGroups),_groups)});if(Object.keys(_groups).find(function(type){return existingGroups[type]!==_groups[type];})){_this27.reloadFeatureFlags();}});}},{key:"group",value:function group(groupType,groupKey,groupProperties,options){var _this28=this;this.wrap(function(){_this28.groups((0,_defineProperty2["default"])({},groupType,groupKey));if(groupProperties){_this28.groupIdentify(groupType,groupKey,groupProperties,options);}});}},{key:"groupIdentify",value:function groupIdentify(groupType,groupKey,groupProperties,options){var _this29=this;this.wrap(function(){var distinctId=_this29.getDistinctId();var eventProperties=_this29.enrichProperties({});_superPropGet(PostHogCore,"groupIdentifyStateless",_this29,3)([groupType,groupKey,groupProperties,options,distinctId,eventProperties]);});}},{key:"setPersonPropertiesForFlags",value:function setPersonPropertiesForFlags(properties){var _this30=this;this.wrap(function(){var existingProperties=_this30.getPersistedProperty(_types.PostHogPersistedProperty.PersonProperties)||{};_this30.setPersistedProperty(_types.PostHogPersistedProperty.PersonProperties,_objectSpread(_objectSpread({},existingProperties),properties));});}},{key:"resetPersonPropertiesForFlags",value:function resetPersonPropertiesForFlags(){var _this31=this;this.wrap(function(){_this31.setPersistedProperty(_types.PostHogPersistedProperty.PersonProperties,{});});}},{key:"personProperties",value:function personProperties(properties){return this.setPersonPropertiesForFlags(properties);}},{key:"setGroupPropertiesForFlags",value:function setGroupPropertiesForFlags(properties){var _this32=this;this.wrap(function(){var existingProperties=_this32.getPersistedProperty(_types.PostHogPersistedProperty.GroupProperties)||{};if(Object.keys(existingProperties).length!==0){Object.keys(existingProperties).forEach(function(groupType){existingProperties[groupType]=_objectSpread(_objectSpread({},existingProperties[groupType]),properties[groupType]);delete properties[groupType];});}_this32.setPersistedProperty(_types.PostHogPersistedProperty.GroupProperties,_objectSpread(_objectSpread({},existingProperties),properties));});}},{key:"resetGroupPropertiesForFlags",value:function resetGroupPropertiesForFlags(){var _this33=this;this.wrap(function(){_this33.setPersistedProperty(_types.PostHogPersistedProperty.GroupProperties,{});});}},{key:"groupProperties",value:function groupProperties(properties){var _this34=this;this.wrap(function(){_this34.setGroupPropertiesForFlags(properties);});}},{key:"decideAsync",value:(function(){var _decideAsync2=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee17(){var sendAnonDistinctId,_args17=arguments;return _regenerator["default"].wrap(function _callee17$(_context17){while(1)switch(_context17.prev=_context17.next){case 0:sendAnonDistinctId=_args17.length>0&&_args17[0]!==undefined?_args17[0]:true;_context17.next=3;return this._initPromise;case 3:if(!this._decideResponsePromise){_context17.next=5;break;}return _context17.abrupt("return",this._decideResponsePromise);case 5:return _context17.abrupt("return",this._decideAsync(sendAnonDistinctId));case 6:case"end":return _context17.stop();}},_callee17,this);}));function decideAsync(){return _decideAsync2.apply(this,arguments);}return decideAsync;}())},{key:"_decideAsync",value:function(){var _decideAsync3=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee18(){var _this35=this;var sendAnonDistinctId,_args18=arguments;return _regenerator["default"].wrap(function _callee18$(_context18){while(1)switch(_context18.prev=_context18.next){case 0:sendAnonDistinctId=_args18.length>0&&_args18[0]!==undefined?_args18[0]:true;this._decideResponsePromise=this._initPromise.then(function(){var distinctId=_this35.getDistinctId();var groups=_this35.props.$groups||{};var personProperties=_this35.getPersistedProperty(_types.PostHogPersistedProperty.PersonProperties)||{};var groupProperties=_this35.getPersistedProperty(_types.PostHogPersistedProperty.GroupProperties)||{};var extraProperties={$anon_distinct_id:sendAnonDistinctId?_this35.getAnonymousId():undefined};return _superPropGet(PostHogCore,"getDecide",_this35,3)([distinctId,groups,personProperties,groupProperties,extraProperties]).then(function(res){if(res===null||res===void 0?void 0:res.featureFlags){if(_this35.sendFeatureFlagEvent){_this35.flagCallReported={};}var newFeatureFlags=res.featureFlags;var newFeatureFlagPayloads=res.featureFlagPayloads;if(res.errorsWhileComputingFlags){var currentFlags=_this35.getPersistedProperty(_types.PostHogPersistedProperty.FeatureFlags);var currentFlagPayloads=_this35.getPersistedProperty(_types.PostHogPersistedProperty.FeatureFlagPayloads);newFeatureFlags=_objectSpread(_objectSpread({},currentFlags),res.featureFlags);newFeatureFlagPayloads=_objectSpread(_objectSpread({},currentFlagPayloads),res.featureFlagPayloads);}_this35.setKnownFeatureFlags(newFeatureFlags);_this35.setKnownFeatureFlagPayloads(Object.fromEntries(Object.entries(newFeatureFlagPayloads||{}).map(function(_ref5){var _ref6=(0,_slicedToArray2["default"])(_ref5,2),k=_ref6[0],v=_ref6[1];return[k,_this35._parsePayload(v)];})));var sessionReplay=res===null||res===void 0?void 0:res.sessionRecording;if(sessionReplay){_this35.setPersistedProperty(_types.PostHogPersistedProperty.SessionReplay,sessionReplay);_this35.logMsgIfDebug(function(){return console.log('PostHog Debug','Session replay config: ',JSON.stringify(sessionReplay));});}else{_this35.logMsgIfDebug(function(){return console.info('PostHog Debug','Session replay config disabled.');});_this35.setPersistedProperty(_types.PostHogPersistedProperty.SessionReplay,null);}}return res;});})["finally"](function(){_this35._decideResponsePromise=undefined;});return _context18.abrupt("return",this._decideResponsePromise);case 3:case"end":return _context18.stop();}},_callee18,this);}));function _decideAsync(){return _decideAsync3.apply(this,arguments);}return _decideAsync;}()},{key:"setKnownFeatureFlags",value:function setKnownFeatureFlags(featureFlags){var _this36=this;this.wrap(function(){_this36.setPersistedProperty(_types.PostHogPersistedProperty.FeatureFlags,featureFlags);_this36._events.emit('featureflags',featureFlags);});}},{key:"setKnownFeatureFlagPayloads",value:function setKnownFeatureFlagPayloads(featureFlagPayloads){var _this37=this;this.wrap(function(){_this37.setPersistedProperty(_types.PostHogPersistedProperty.FeatureFlagPayloads,featureFlagPayloads);});}},{key:"getFeatureFlag",value:function getFeatureFlag(key){var featureFlags=this.getFeatureFlags();if(!featureFlags){return undefined;}var response=featureFlags[key];if(response===undefined){response=false;}if(this.sendFeatureFlagEvent&&!this.flagCallReported[key]){this.flagCallReported[key]=true;this.capture('$feature_flag_called',{$feature_flag:key,$feature_flag_response:response});}return response;}},{key:"getFeatureFlagPayload",value:function getFeatureFlagPayload(key){var payloads=this.getFeatureFlagPayloads();if(!payloads){return undefined;}var response=payloads[key];if(response===undefined){return null;}return response;}},{key:"getFeatureFlagPayloads",value:function getFeatureFlagPayloads(){var payloads=this.getPersistedProperty(_types.PostHogPersistedProperty.FeatureFlagPayloads);return payloads;}},{key:"getFeatureFlags",value:function getFeatureFlags(){var flags=this.getPersistedProperty(_types.PostHogPersistedProperty.FeatureFlags);var overriddenFlags=this.getPersistedProperty(_types.PostHogPersistedProperty.OverrideFeatureFlags);if(!overriddenFlags){return flags;}flags=flags||{};for(var key in overriddenFlags){if(!overriddenFlags[key]){delete flags[key];}else{flags[key]=overriddenFlags[key];}}return flags;}},{key:"getFeatureFlagsAndPayloads",value:function getFeatureFlagsAndPayloads(){var flags=this.getFeatureFlags();var payloads=this.getFeatureFlagPayloads();return{flags:flags,payloads:payloads};}},{key:"isFeatureEnabled",value:function isFeatureEnabled(key){var response=this.getFeatureFlag(key);if(response===undefined){return undefined;}return!!response;}},{key:"reloadFeatureFlags",value:function reloadFeatureFlags(cb){var _this38=this;this.decideAsync().then(function(res){cb===null||cb===void 0?void 0:cb(undefined,res===null||res===void 0?void 0:res.featureFlags);})["catch"](function(e){cb===null||cb===void 0?void 0:cb(e,undefined);if(!cb){_this38.logMsgIfDebug(function(){return console.log('[PostHog] Error reloading feature flags',e);});}});}},{key:"reloadFeatureFlagsAsync",value:function(){var _reloadFeatureFlagsAsync=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee19(){var sendAnonDistinctId,_a,_args19=arguments;return _regenerator["default"].wrap(function _callee19$(_context19){while(1)switch(_context19.prev=_context19.next){case 0:sendAnonDistinctId=_args19.length>0&&_args19[0]!==undefined?_args19[0]:true;_context19.next=3;return this.decideAsync(sendAnonDistinctId);case 3:_context19.t1=_a=_context19.sent;_context19.t0=_context19.t1===null;if(_context19.t0){_context19.next=7;break;}_context19.t0=_a===void 0;case 7:if(!_context19.t0){_context19.next=11;break;}_context19.t2=void 0;_context19.next=12;break;case 11:_context19.t2=_a.featureFlags;case 12:return _context19.abrupt("return",_context19.t2);case 13:case"end":return _context19.stop();}},_callee19,this);}));function reloadFeatureFlagsAsync(){return _reloadFeatureFlagsAsync.apply(this,arguments);}return reloadFeatureFlagsAsync;}()},{key:"onFeatureFlags",value:function onFeatureFlags(cb){var _this39=this;return this.on('featureflags',(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee20(){var flags;return _regenerator["default"].wrap(function _callee20$(_context20){while(1)switch(_context20.prev=_context20.next){case 0:flags=_this39.getFeatureFlags();if(flags){cb(flags);}case 2:case"end":return _context20.stop();}},_callee20);})));}},{key:"onFeatureFlag",value:function onFeatureFlag(key,cb){var _this40=this;return this.on('featureflags',(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee21(){var flagResponse;return _regenerator["default"].wrap(function _callee21$(_context21){while(1)switch(_context21.prev=_context21.next){case 0:flagResponse=_this40.getFeatureFlag(key);if(flagResponse!==undefined){cb(flagResponse);}case 2:case"end":return _context21.stop();}},_callee21);})));}},{key:"overrideFeatureFlag",value:function(){var _overrideFeatureFlag=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee22(flags){var _this41=this;return _regenerator["default"].wrap(function _callee22$(_context22){while(1)switch(_context22.prev=_context22.next){case 0:this.wrap(function(){if(flags===null){return _this41.setPersistedProperty(_types.PostHogPersistedProperty.OverrideFeatureFlags,null);}return _this41.setPersistedProperty(_types.PostHogPersistedProperty.OverrideFeatureFlags,flags);});case 1:case"end":return _context22.stop();}},_callee22,this);}));function overrideFeatureFlag(_x15){return _overrideFeatureFlag.apply(this,arguments);}return overrideFeatureFlag;}()}]);}(PostHogCoreStateless);