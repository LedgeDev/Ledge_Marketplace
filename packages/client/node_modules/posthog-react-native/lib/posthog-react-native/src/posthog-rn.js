"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.PostHog=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _get2=_interopRequireDefault(require("@babel/runtime/helpers/get"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _reactNative=require("react-native");var _src=require("../../posthog-core/src");var _legacy=require("./legacy");var _storage=require("./storage");var _version=require("./version");var _nativeDeps=require("./native-deps");var _wixNavigation=require("./frameworks/wix-navigation");var _OptionalSessionReplay=require("./optional/OptionalSessionReplay");function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable;})),t.push.apply(t,o);}return t;}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach(function(r){(0,_defineProperty2["default"])(e,r,t[r]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r));});}return e;}function _callSuper(t,o,e){return o=(0,_getPrototypeOf2["default"])(o),(0,_possibleConstructorReturn2["default"])(t,_isNativeReflectConstruct()?Reflect.construct(o,e||[],(0,_getPrototypeOf2["default"])(t).constructor):o.apply(t,e));}function _isNativeReflectConstruct(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));}catch(t){}return(_isNativeReflectConstruct=function _isNativeReflectConstruct(){return!!t;})();}function _superPropGet(t,e,o,r){var p=(0,_get2["default"])((0,_getPrototypeOf2["default"])(1&r?t.prototype:t),e,o);return 2&r&&"function"==typeof p?function(t){return p.apply(o,t);}:p;}var PostHog=exports.PostHog=function(_PostHogCore){function PostHog(apiKey,options){var _this;(0,_classCallCheck2["default"])(this,PostHog);var _a,_b;_this=_callSuper(this,PostHog,[apiKey,options]);_this._appProperties={};_this._isInitialized=false;_this._persistence=(_a=options===null||options===void 0?void 0:options.persistence)!==null&&_a!==void 0?_a:'file';_this._appProperties=typeof(options===null||options===void 0?void 0:options.customAppProperties)==='function'?options.customAppProperties((0,_nativeDeps.getAppProperties)()):(options===null||options===void 0?void 0:options.customAppProperties)||(0,_nativeDeps.getAppProperties)();_reactNative.AppState.addEventListener('change',function(){void _this.flush();});var storagePromise;if(_this._persistence==='file'){_this._storage=new _storage.PostHogRNStorage((_b=options===null||options===void 0?void 0:options.customStorage)!==null&&_b!==void 0?_b:(0,_nativeDeps.buildOptimisiticAsyncStorage)());storagePromise=_this._storage.preloadPromise;}else{_this._storage=new _storage.PostHogRNSyncMemoryStorage();}if(storagePromise){storagePromise.then(function(){if(!_this._storage.getItem(_src.PostHogPersistedProperty.AnonymousId)){void(0,_legacy.getLegacyValues)().then(function(legacyValues){var _a,_b;if(legacyValues===null||legacyValues===void 0?void 0:legacyValues.distinctId){(_a=_this._storage)===null||_a===void 0?void 0:_a.setItem(_src.PostHogPersistedProperty.DistinctId,legacyValues.distinctId);(_b=_this._storage)===null||_b===void 0?void 0:_b.setItem(_src.PostHogPersistedProperty.AnonymousId,legacyValues.anonymousId);}});}});}var initAfterStorage=function initAfterStorage(){var enablePersistSessionIdAcrossRestart=options===null||options===void 0?void 0:options.enablePersistSessionIdAcrossRestart;if(!enablePersistSessionIdAcrossRestart){_this.setPersistedProperty(_src.PostHogPersistedProperty.SessionId,null);_this.setPersistedProperty(_src.PostHogPersistedProperty.SessionLastTimestamp,null);}_this.setupBootstrap(options);_this._isInitialized=true;if((options===null||options===void 0?void 0:options.preloadFeatureFlags)!==false){_this.reloadFeatureFlags();}if(options===null||options===void 0?void 0:options.captureNativeAppLifecycleEvents){if(_this._persistence==='memory'){_this.logMsgIfDebug(function(){return console.warn('PostHog was initialised with persistence set to "memory", capturing native app events is not supported.');});}else{void _this.captureNativeAppLifecycleEvents();}}void _this.persistAppVersion();void _this.startSessionReplay(options);};if(storagePromise){_this._initPromise=storagePromise.then(initAfterStorage);}else{_this._initPromise=Promise.resolve();initAfterStorage();}return _this;}(0,_inherits2["default"])(PostHog,_PostHogCore);return(0,_createClass2["default"])(PostHog,[{key:"ready",value:function(){var _ready=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee(){return _regenerator["default"].wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:_context.next=2;return this._initPromise;case 2:case"end":return _context.stop();}},_callee,this);}));function ready(){return _ready.apply(this,arguments);}return ready;}()},{key:"getPersistedProperty",value:function getPersistedProperty(key){return this._storage.getItem(key);}},{key:"setPersistedProperty",value:function setPersistedProperty(key,value){return value!==null?this._storage.setItem(key,value):this._storage.removeItem(key);}},{key:"fetch",value:function(_fetch){function fetch(_x,_x2){return _fetch.apply(this,arguments);}fetch.toString=function(){return _fetch.toString();};return fetch;}(function(url,options){return fetch(url,options);})},{key:"getLibraryId",value:function getLibraryId(){return'posthog-react-native';}},{key:"getLibraryVersion",value:function getLibraryVersion(){return _version.version;}},{key:"getCustomUserAgent",value:function getCustomUserAgent(){if(_reactNative.Platform.OS==='web'){return'';}return"".concat(this.getLibraryId(),"/").concat(this.getLibraryVersion());}},{key:"getCommonEventProperties",value:function getCommonEventProperties(){return _objectSpread(_objectSpread(_objectSpread({},_superPropGet(PostHog,"getCommonEventProperties",this,3)([])),this._appProperties),{},{$screen_height:_reactNative.Dimensions.get('screen').height,$screen_width:_reactNative.Dimensions.get('screen').width});}},{key:"screen",value:function(){var _screen=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee2(name,properties,options){return _regenerator["default"].wrap(function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:_context2.next=2;return this._initPromise;case 2:this.registerForSession({$screen_name:name});return _context2.abrupt("return",this.capture('$screen',_objectSpread(_objectSpread({},properties),{},{$screen_name:name}),options));case 4:case"end":return _context2.stop();}},_callee2,this);}));function screen(_x3,_x4,_x5){return _screen.apply(this,arguments);}return screen;}()},{key:"_isEnableSessionReplay",value:function _isEnableSessionReplay(){var _a;return!this.isDisabled&&((_a=this._enableSessionReplay)!==null&&_a!==void 0?_a:false);}},{key:"_resetSessionId",value:function _resetSessionId(reactNativeSessionReplay,sessionId){if(reactNativeSessionReplay){reactNativeSessionReplay.endSession();reactNativeSessionReplay.startSession(sessionId);}}},{key:"getSessionId",value:function getSessionId(){var sessionId=_superPropGet(PostHog,"getSessionId",this,3)([]);if(!this._isEnableSessionReplay()){return sessionId;}if(sessionId.length>0&&this._currentSessionId&&sessionId!==this._currentSessionId){if(_OptionalSessionReplay.OptionalReactNativeSessionReplay){try{this._resetSessionId(_OptionalSessionReplay.OptionalReactNativeSessionReplay,sessionId);this.logMsgIfDebug(function(){return console.info('PostHog Debug',"Session replay started with sessionId ".concat(sessionId,"."));});}catch(e){this.logMsgIfDebug(function(){return console.error('PostHog Debug',"Session replay failed to start with sessionId: ".concat(e,"."));});}}this._currentSessionId=sessionId;}else{console.log('PostHog Debug',"Session replay session id not rotated, sessionId ".concat(sessionId," and currentSessionId ").concat(this._currentSessionId,"."));}return sessionId;}},{key:"resetSessionId",value:function resetSessionId(){_superPropGet(PostHog,"resetSessionId",this,3)([]);if(this._isEnableSessionReplay()&&_OptionalSessionReplay.OptionalReactNativeSessionReplay){try{_OptionalSessionReplay.OptionalReactNativeSessionReplay.endSession();this.logMsgIfDebug(function(){return console.info('PostHog Debug',"Session replay ended.");});}catch(e){this.logMsgIfDebug(function(){return console.error('PostHog Debug',"Session replay failed to end: ".concat(e,"."));});}}}},{key:"identify",value:function identify(distinctId,properties,options){var previousDistinctId=this.getDistinctId();_superPropGet(PostHog,"identify",this,3)([distinctId,properties,options]);if(this._isEnableSessionReplay()&&_OptionalSessionReplay.OptionalReactNativeSessionReplay){try{distinctId=distinctId||previousDistinctId;_OptionalSessionReplay.OptionalReactNativeSessionReplay.identify(distinctId,this.getAnonymousId());this.logMsgIfDebug(function(){return console.info('PostHog Debug',"Session replay identified with distinctId ".concat(distinctId,"."));});}catch(e){this.logMsgIfDebug(function(){return console.error('PostHog Debug',"Session replay failed to identify: ".concat(e,"."));});}}}},{key:"initReactNativeNavigation",value:function initReactNativeNavigation(options){return(0,_wixNavigation.withReactNativeNavigation)(this,options);}},{key:"startSessionReplay",value:function(){var _startSessionReplay=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee3(options){var _a,_b,_c,_ref,_ref$maskAllTextInput,maskAllTextInputs,_ref$maskAllImages,maskAllImages,_ref$maskAllSandboxed,maskAllSandboxedViews,_ref$maskPhotoLibrary,maskPhotoLibraryImages,_ref$captureLog,captureLog,_ref$captureNetworkTe,captureNetworkTelemetry,_ref$iOSdebouncerDela,iOSdebouncerDelayMs,_ref$androidDebouncer,androidDebouncerDelayMs,sdkReplayConfig,sessionReplay,decideReplayConfig,sessionId,sdkOptions;return _regenerator["default"].wrap(function _callee3$(_context3){while(1)switch(_context3.prev=_context3.next){case 0:this._enableSessionReplay=options===null||options===void 0?void 0:options.enableSessionReplay;if(this._isEnableSessionReplay()){_context3.next=4;break;}this.logMsgIfDebug(function(){return console.info('PostHog Debug','Session replay is not enabled.');});return _context3.abrupt("return");case 4:_ref=(_a=options===null||options===void 0?void 0:options.sessionReplayConfig)!==null&&_a!==void 0?_a:{},_ref$maskAllTextInput=_ref.maskAllTextInputs,maskAllTextInputs=_ref$maskAllTextInput===void 0?true:_ref$maskAllTextInput,_ref$maskAllImages=_ref.maskAllImages,maskAllImages=_ref$maskAllImages===void 0?true:_ref$maskAllImages,_ref$maskAllSandboxed=_ref.maskAllSandboxedViews,maskAllSandboxedViews=_ref$maskAllSandboxed===void 0?true:_ref$maskAllSandboxed,_ref$maskPhotoLibrary=_ref.maskPhotoLibraryImages,maskPhotoLibraryImages=_ref$maskPhotoLibrary===void 0?true:_ref$maskPhotoLibrary,_ref$captureLog=_ref.captureLog,captureLog=_ref$captureLog===void 0?true:_ref$captureLog,_ref$captureNetworkTe=_ref.captureNetworkTelemetry,captureNetworkTelemetry=_ref$captureNetworkTe===void 0?true:_ref$captureNetworkTe,_ref$iOSdebouncerDela=_ref.iOSdebouncerDelayMs,iOSdebouncerDelayMs=_ref$iOSdebouncerDela===void 0?1000:_ref$iOSdebouncerDela,_ref$androidDebouncer=_ref.androidDebouncerDelayMs,androidDebouncerDelayMs=_ref$androidDebouncer===void 0?1000:_ref$androidDebouncer;sdkReplayConfig={maskAllTextInputs:maskAllTextInputs,maskAllImages:maskAllImages,maskAllSandboxedViews:maskAllSandboxedViews,maskPhotoLibraryImages:maskPhotoLibraryImages,captureLog:captureLog,captureNetworkTelemetry:captureNetworkTelemetry,iOSdebouncerDelayMs:iOSdebouncerDelayMs,androidDebouncerDelayMs:androidDebouncerDelayMs};this.logMsgIfDebug(function(){return console.log('PostHog Debug',"Session replay sdk config: ".concat(JSON.stringify(sdkReplayConfig)));});sessionReplay=(_b=this.getPersistedProperty(_src.PostHogPersistedProperty.SessionReplay))!==null&&_b!==void 0?_b:{};if(!sessionReplay){_context3.next=39;break;}decideReplayConfig=(_c=sessionReplay)!==null&&_c!==void 0?_c:{};this.logMsgIfDebug(function(){return console.log('PostHog Debug',"Session replay decide cached config: ".concat(JSON.stringify(decideReplayConfig)));});if(!_OptionalSessionReplay.OptionalReactNativeSessionReplay){_context3.next=36;break;}sessionId=this.getSessionId();if(!(sessionId.length===0)){_context3.next=16;break;}this.logMsgIfDebug(function(){return console.warn('PostHog Debug','Session replay enabled but no sessionId found.');});return _context3.abrupt("return");case 16:sdkOptions={apiKey:this.apiKey,host:this.host,debug:this.isDebug,distinctId:this.getDistinctId(),anonymousId:this.getAnonymousId(),sdkVersion:this.getLibraryVersion(),flushAt:this.flushAt};this.logMsgIfDebug(function(){return console.log('PostHog Debug',"Session replay sdk options: ".concat(JSON.stringify(sdkOptions)));});_context3.prev=18;_context3.next=21;return _OptionalSessionReplay.OptionalReactNativeSessionReplay.isEnabled();case 21:if(_context3.sent){_context3.next=27;break;}_context3.next=24;return _OptionalSessionReplay.OptionalReactNativeSessionReplay.start(sessionId,sdkOptions,sdkReplayConfig,decideReplayConfig);case 24:this.logMsgIfDebug(function(){return console.info('PostHog Debug',"Session replay started with sessionId ".concat(sessionId,"."));});_context3.next=29;break;case 27:this._resetSessionId(_OptionalSessionReplay.OptionalReactNativeSessionReplay,sessionId);this.logMsgIfDebug(function(){return console.log('PostHog Debug',"Session replay already started with sessionId ".concat(sessionId,"."));});case 29:_context3.next=34;break;case 31:_context3.prev=31;_context3.t0=_context3["catch"](18);this.logMsgIfDebug(function(){return console.error('PostHog Debug',"Session replay failed to start: ".concat(_context3.t0,"."));});case 34:_context3.next=37;break;case 36:this.logMsgIfDebug(function(){return console.warn('PostHog Debug','Session replay enabled but not installed.');});case 37:_context3.next=40;break;case 39:this.logMsgIfDebug(function(){return console.info('PostHog Debug','Session replay disabled.');});case 40:case"end":return _context3.stop();}},_callee3,this,[[18,31]]);}));function startSessionReplay(_x6){return _startSessionReplay.apply(this,arguments);}return startSessionReplay;}()},{key:"captureNativeAppLifecycleEvents",value:function(){var _captureNativeAppLifecycleEvents=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee4(){var _this2=this;var _a,prevAppBuild,prevAppVersion,appBuild,appVersion,initialUrl;return _regenerator["default"].wrap(function _callee4$(_context4){while(1)switch(_context4.prev=_context4.next){case 0:prevAppBuild=this.getPersistedProperty(_src.PostHogPersistedProperty.InstalledAppBuild);prevAppVersion=this.getPersistedProperty(_src.PostHogPersistedProperty.InstalledAppVersion);appBuild=this._appProperties.$app_build;appVersion=this._appProperties.$app_version;if(!appBuild||!appVersion){this.logMsgIfDebug(function(){return console.warn('PostHog could not track installation/update/open, as the build and version were not set. '+'This can happen if some dependencies are not installed correctly, or if you have provided'+'customAppProperties but not included $app_build or $app_version.');});}if(appBuild){if(!prevAppBuild){this.capture('Application Installed',{version:appVersion,build:appBuild});}else if(prevAppBuild!==appBuild){this.capture('Application Updated',{previous_version:prevAppVersion,previous_build:prevAppBuild,version:appVersion,build:appBuild});}}_context4.next=8;return _reactNative.Linking.getInitialURL();case 8:_context4.t1=_a=_context4.sent;_context4.t0=_context4.t1!==null;if(!_context4.t0){_context4.next=12;break;}_context4.t0=_a!==void 0;case 12:if(!_context4.t0){_context4.next=16;break;}_context4.t2=_a;_context4.next=17;break;case 16:_context4.t2=undefined;case 17:initialUrl=_context4.t2;this.capture('Application Opened',{version:appVersion,build:appBuild,url:initialUrl});_reactNative.AppState.addEventListener('change',function(state){if(state==='active'){_this2.capture('Application Became Active',{version:appVersion,build:appBuild});}else if(state==='background'){_this2.capture('Application Backgrounded');}});case 20:case"end":return _context4.stop();}},_callee4,this);}));function captureNativeAppLifecycleEvents(){return _captureNativeAppLifecycleEvents.apply(this,arguments);}return captureNativeAppLifecycleEvents;}()},{key:"persistAppVersion",value:function(){var _persistAppVersion=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee5(){var appBuild,appVersion;return _regenerator["default"].wrap(function _callee5$(_context5){while(1)switch(_context5.prev=_context5.next){case 0:appBuild=this._appProperties.$app_build;appVersion=this._appProperties.$app_version;this.setPersistedProperty(_src.PostHogPersistedProperty.InstalledAppBuild,appBuild);this.setPersistedProperty(_src.PostHogPersistedProperty.InstalledAppVersion,appVersion);case 4:case"end":return _context5.stop();}},_callee5,this);}));function persistAppVersion(){return _persistAppVersion.apply(this,arguments);}return persistAppVersion;}()}]);}(_src.PostHogCore);